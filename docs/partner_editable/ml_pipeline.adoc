== How to retrain the model or use a custom model in the pipeline
This Quick Start deploys an ML pipeline, including a model-training workflow and a batch-processing workflow. This pipeline generates data that becomes the basis for forecasts and anomaly results. The initial deployment executes both workflows after ETL jobs are done.

After new data is added, you can rerun the whole AWS CloudFormation to reprocess the entire data and train a new model, or you might want to just rerun each part at a different schedule. For example, run the AWS Glue ETL workflow daily to process and format new data; run the batch workflow weekly to generate forecast and anomaly for new data; and run the model-training workflow monthly to retrain the model to learn new customer-consumption patterns. You can also use a custom model for batch pipeline and forecast API.

=== Run the batch prediction pipeline

. The batch pipeline is implemented by Step Functions. Go to the Step Functions console in your AWS account, and find the state machine with the prefix `PredictionPipelineStateMachine-`.
+
:xrefstyle: short
[#step_function_console]
.AWS Step Functions console
image::../images/1_batchpipeline.png[AWS Step Functions console]

. Open the state machine, and choose *Start execution*.
+
:xrefstyle: short
[#batch_pipeline_execution]
.Batch pipeline execution
image::../images/2_batchpipeline_execution.png[Batch pipeline execution]

The input parameter needs to contain the following information in JSON format. You can specify the range of meters you want to process and the date range of your data. Note that `Batch_size` should not exceed 100. You can also specify a customer model that you trained in SageMaker.
```json
{
  "Meter_start": 1,
  "Meter_end": 50,
  "Batch_size": 25,
  "Data_start": "2013-01-01",
  "Data_end": "2013-10-01",
  "Forecast_period": 7,
  "ModelName": "ml-model-0731"
}
```

=== Retrain the model with different parameters

. Go to the Step Functions console, and find the state machine with prefix `InitialTrainingStateMachine-`. 
. Open the state machine, and choose *Definition*. 
. Find the `HyperParameters` part, and modify the parameters or add more parameters. See https://docs.aws.amazon.com/sagemaker/latest/dg/deepar_hyperparameters.html[DeepAR Hyperparameters^].  
+
:xrefstyle: short
[#hyperparameters]
.Hyperparameters
image::../images/3_trainingpipeline_hyperparameters.png[HyperParameters]

. Save change to the state machine, and choose *Start execution*. The input parameter needs to contain the following information in JSON format. `Training_samples` specifies how many meters' data will be used to train the model. The more meters are used, the more accurate the model will be and the longer the training will take. 

. Give a new name for `ModelName` and `ML_endpoint_name`.
+
```json
{
  "Training_samples": 20,
  "Data_start": "2013-01-01",
  "Data_end": "2013-10-01",
  "Forecast_period": 7,
  "ModelName": "ml-model-0731",
  "ML_endpoint_name": "ml-model-0731"
}
```
